<!DOCTYPE html>

<html>

	<style>
		
		#theBody{
			background-color: #aaaaaa;
		}
		#fileinput{
			color: black;
		}
		
	</style>
	<body id="theBody">
	
		
	
	
		<input type="file" id="fileinput" multiple ></input>
		<button style="display: inline;" onclick="renderXML()">Render XML</button>
		<a href="" id="downloadLink" download="parts_properties2.xml" ></a>
		
		
		
		<table id="table_id" class="display">
			<thead>
				<tr>
					<th>NAME</th>
					<th>VOLUME</th>
					<th>SURFACE AREA</th>
					<th>MASS</th>
					<th>FASTENER</th>
					<th>AMBIGUITY</th>
				</tr>
			</thead>
			<tbody id="body_id">

			</tbody>
			<tfoot>
				<tr>
					<th>NAME</th>
					<th>VOLUME</th>
					<th>SURFACE AREA</th>
					<th>MASS</th>
					<th>FASTENER</th>
					<th>AMBIGUITY</th>
				</tr>
			</tfoot>
		</table>
		
		
		
		
		
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/gojs/1.6.7/go-debug.js"></script>
		<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.12/datatables.css"/>

		<script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.12/datatables.js"></script>
	
	</body>
	<script>
	
		var fileReaders=[];
		var inputXML=null;
		var textFile=null;
		
		var massElem="<button onclick='insertMassInput(this)'>Input By Mass</button><button onclick='insertDensityInput(this)'>Input By Volume+Density</button>";
		
		
		var theTable= $('#table_id').DataTable();
		
		//document.getElementById("downloadLink").setAttribute("style","display: none");
		
	
		function grabExtension(theName){
			return (/[.]/.exec(theName)) ? /[^.]+$/.exec(theName) : undefined;
		}
		
		function getChildrenByTag(theNode,tag){
			var childs=theNode.children;
			var pos=0;
			var lim=childs.length;
			var result=[];
			while(pos<lim){
				if(childs[pos].tagName===tag){
					result.push(childs[pos]);
				}
				pos++;
			}
			return result;
		}
	
		function readMultipleFiles(evt) {
			//Retrieve all the files from the FileList object
			var files = evt.target.files; 
					
			if (files) {
				for (var i=0, f; f=files[i]; i++) {
					
					var r = new FileReader();
					var extension=grabExtension(f.name)[0];
					console.log(f.name);
					
					if(extension===undefined){
						continue;
					}
					if(extension.toLowerCase()==="xml"){
						if(!(inputXML===null)){
							console.log("Warning: More than one XML file provided");
						}
						r.onload = (function(f) {
							return function(e) {
								console.log(f.name);
								var contents = e.target.result;
								inputXML=r.result;
								loadParts();
							};
						})(f);
						r.readAsText(f,"US-ASCII");
						fileReaders.push({Reader: r, Name: f.name});
					}
								
				}
				console.log(fileReaders);
			} 
			else {
				  alert("Failed to load files"); 
			}
		}
		
		
		document.getElementById('fileinput').addEventListener('change', readMultipleFiles, false);
		
		
		
		
		function loadParts (){
		
			var pos=0;
			var lim=fileReaders.length;
			while(pos<lim){
				if(!(fileReaders[pos].Reader.readyState===2)){
					console.log(pos);
					console.log(fileReaders[pos].Name);
					break;
				}
				pos++;
			}
			if(pos===lim){
				console.log("ALL DONE");
				fillOutTable(inputXML);				
			}
		}
		
		
		
	
	
		function grab(theTree,theMember){

			if($(theTree).children(theMember).length!=0){
				
				return $(theTree).children(theMember)[0];
				
			}
			else{
			
				return null;
			
			}

		}

		function grabInd(theTree,theMember, theIndex){

			if($(theTree).children(theMember).length>theIndex){
				
				return $(theTree).children(theMember)[theIndex];
				
			}
			else{
			
				return null;
			
			}

		}
		
		function addEntry(theEntry){
		
			var theName=grab(theEntry,"name").innerHTML;
			var theVolume=Number.parseFloat(grab(theEntry,"volume").innerHTML);
			var theMass=massElem;
			var theCertainty=Number.parseFloat(grab(theEntry,"fastener_certainty").innerHTML);
			var theSurfaceArea=Number.parseFloat(grab(theEntry,"surface_area").innerHTML);
			
			var fstChecked="<input type='checkbox'></input>";
			if(theCertainty>0.5){
				fstChecked="<input type='checkbox' checked></input>";
			}
			
			var theAmbiguity=1-2*Math.abs(theCertainty-0.5);
			theAmbiguity=theAmbiguity.toFixed(2);
			
			theTable.row.add( [
				theName,
				theVolume,
				theSurfaceArea,
				theMass,
				fstChecked,
				theAmbiguity
			] ).draw();
			
		}
		
		function fillOutTable(theXMLText){
		
			var theXML=$.parseXML(theXMLText);
			console.log(theXML);
			//console.log(theXML);
			var theEntries=grab(theXML,"parts_properties");
			var theEntries=$(theEntries).children("part_properties");
			var pos=0;
			var lim=theEntries.length;
			var name;
			var classif;
			while(pos<lim){
				addEntry(theEntries[pos]);
				pos++;
			}
		
		}
		
		
		
		function renderXML(){
			
			
			var result="<?xml version='1.0' encoding='utf-8'?>\n<parts_properties xmlns:xsd='http://www.w3.org/2001/XMLSchema' xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'>\n";
			
			theTable=document.getElementById("body_id");
			console.log(theTable);
			
			var theEntries=getChildrenByTag(theTable,"TR");
			console.log(theEntries);
			var entryPos=0;
			var entryLim=theEntries.length;
			
			var theCells;
			
			
			while(entryPos<entryLim){
				
				result=result+renderEntry(getChildrenByTag(theEntries[entryPos],"TD"));
				entryPos++;
			}
			
			result+="</parts_properties>";
			
			console.log(result);
			
			
			var data = new Blob([result], {type: 'text/plain'});

			if (textFile !== null) {
			  window.URL.revokeObjectURL(textFile);
			}

			textFile = window.URL.createObjectURL(data);

			
			document.getElementById("downloadLink").setAttribute("style","color: white; display: inline;");
			document.getElementById("downloadLink").innerHTML="Download";
			document.getElementById("downloadLink").href=textFile;
		
		}
		
		
		function renderEntry(theCells){
		
			
			var massCell=theCells[3];
			console.log(massCell);
			var buttons=getChildrenByTag(massCell,"BUTTON");
			var inputs=getChildrenByTag(massCell,"INPUT");
			
			var massText="";
			if(inputs.length==0){
				alert("Mass data not provided for one or more cells");
			}
			else if(inputs.length==1){
				if(buttons.length==1){
					massText="  <mass>"+inputs[0].value+"</mass>\n";
				}
				else if(buttons.length==2){
					massText="  <mass>"+Number.parseFloat(inputs[0].value)*Number.parseFloat(theCells[1].innerHTML)+"</mass>\n";
				}
				else{
					alert("HTML Corrupted");
				}
			}
			else if(inputs.length==2){
					massText="  <mass>"+Number.parseFloat(inputs[0].value)*Number.parseFloat(inputs[1].value)*Number.parseFloat(theCells[2].innerHTML)+"</mass>\n";
			}
			else{
				alert("HTML Corrupted");
			}
			
			
			
			
			var checkText="  <fastener_certainty>0</fastener_certainty>\n";
			if(theCells[4].checked){
				checkText="  <fastener_certainty>1</fastener_certainty>\n";
			}
			
		
			var result="";
			result=result+"<part_properties>\n";
			result=result+"  <name>"+theCells[0].innerHTML+"</name>\n";
			result=result+massText;
			result=result+"  <volume>"+theCells[1].innerHTML+"</volume>\n";
			result=result+"  <surface_area>"+theCells[2].innerHTML+"</surface_area>\n";
			result=result+checkText;
			result=result+"</part_properties>\n";
			return result;
		
		}
		
		
		
		function hollowOpt(theCheckBox){
		
			theCheckBox.parentElement.innerHTML="<input type='text' onchange='revertHollowOpt(this)'> </input>";
		
		}
		
		function revertHollowOpt(theTextBox){
		
			if(isNaN(Number.parseFloat(theTextBox.value))){
				theTextBox.parentElement.innerHTML="<text>hollow </text><input type='checkbox' onchange='hollowOpt(this)'> </input>";
			}
		
		}
		
		function insertMassInput(theButton){
		
			theButton.parentElement.innerHTML="<button onclick='insertDensityInput(this)'>Input By Volume+Density</button>Mass: <input type='text'></input>";
		
		}
		
		function insertDensityInput(theButton){
		
			theButton.parentElement.innerHTML="<button onclick='insertMassInput(this)'>Input By Mass</button>Density: <input type='text'></input><button onclick='insertThicknessInput(this)'>Hollow</button>";
		
		}
		
		function insertThicknessInput(theButton){
		
			theButton.parentElement.innerHTML="<button onclick='insertMassInput(this)'>Input By Mass</button>Density: <input type='text'></input>Thickness: <input type='text'></input>";
		
		}
		
		
	
	</script>
</html>

